<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chroma Converter | Tools</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* ======== CHROMA TOOL STYLES ======== */
        .chroma-interface {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            margin-top: 2rem;
        }

        .panel {
            background: #222;
            border: 4px solid var(--color-border);
            padding: 1.5rem;
            flex: 1;
            min-width: 300px;
        }

        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #444;
            padding-bottom: 1rem;
        }

        .search-row input {
            flex-grow: 1;
            background: #000;
            border: 2px solid #555;
            color: #fff;
            padding: 8px;
            font-family: 'Courier New', monospace;
        }

        .search-btn {
            background: var(--color-accent);
            color: #000;
            border: none;
            padding: 0 15px;
            cursor: pointer;
            font-family: var(--font-pixel);
            font-weight: bold;
        }
        .search-btn:hover { background: #fff; }

        #mainSwatch {
            height: 150px;
            width: 100%;
            border: 4px inset #111;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            align-items: center;
        }

        .input-row label {
            width: 50px;
            color: #aaa;
            font-family: var(--font-pixel);
            text-transform: uppercase;
        }

        .input-row input {
            flex-grow: 1;
            background: #000;
            border: 2px solid #555;
            color: #fff;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
        }

        /* ======== PALETTE STYLES (NEW) ======== */
        .palette-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .palette-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .palette-btn {
            width: 35px;
            height: 35px;
            border: 2px solid #fff;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .palette-btn:hover { transform: scale(1.1); z-index: 2; }
        
        .add-btn {
            width: 35px;
            height: 35px;
            background: #333;
            color: #fff;
            border: 2px dashed #666;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .add-btn:hover { border-color: var(--color-accent); color: var(--color-accent); }

        .reset-link {
            font-size: 0.75rem;
            color: #666;
            text-decoration: underline;
            cursor: pointer;
            background: none; border: none;
            font-family: var(--font-pixel);
        }
        .reset-link:hover { color: #f00; }

        .identity-box {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #333;
        }
        .identity-box h3 {
            margin: 0.25rem 0 0.5rem 0;
            font-size: 1.5rem;
            color: #fff;
            font-family: var(--font-pixel);
            letter-spacing: 1px;
        }
        .exact-tag {
            font-size: 0.75rem;
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            color: #aaa;
        }
        .exact-tag.yes { background: var(--color-accent); color: #000; font-weight: bold; }
        .exact-tag.fail { background: #dc3545; color: #fff; }

        .contrast-box {
            padding: 1rem;
            margin-top: 1rem;
            border: 2px solid #444;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-family: sans-serif;
            font-weight: bold;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.8rem;
            border-radius: 4px;
            margin-left: 10px;
            font-family: var(--font-pixel);
        }
        .pass { background: #28a745; color: white; }
        .fail { background: #dc3545; color: white; }

        /* ======== VISUAL PICKER STYLES ======== */
        .picker-area {
            position: relative;
            width: 100%;
            height: 180px;
            margin-bottom: 1rem;
            cursor: crosshair;
            background-color: red;
            border: 2px solid #555;
        }
        .picker-white {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to right, #fff, transparent);
        }
        .picker-black {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, transparent, #000);
        }
        .picker-cursor {
            position: absolute; width: 12px; height: 12px;
            border: 2px solid #fff; border-radius: 50%;
            box-shadow: 0 0 2px #000;
            transform: translate(-50%, -50%); pointer-events: none;
            top: 0; left: 100%;
        }
        .hue-slider-container { margin-bottom: 1.5rem; }
        input[type=range].hue-range {
            -webkit-appearance: none; width: 100%; height: 15px;
            border-radius: 10px; outline: none; border: 2px solid #555;
            background: linear-gradient(to right, #f00 0%, #ff0 17%, #0f0 33%, #0ff 50%, #00f 67%, #f0f 83%, #f00 100%);
        }
        input[type=range].hue-range::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            border-radius: 50%; background: #fff; border: 2px solid #000; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="site-wrapper">
        <header class="site-header"><h1>Chroma Converter</h1></header>

        <nav class="site-nav">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/trophy-case/">Trophy Case</a></li>
                <li><a href="/tools/" class="current">Tools</a></li>
                <li><a href="/library/">Library</a></li>
            </ul>
        </nav>

        <main class="site-content">
            <p>Convert colors, check accessibility, and find color names.</p>

            <div class="chroma-interface">
                
                <div class="panel">
                    <h2>Color Mixer</h2>
                    
                    <div class="search-row">
                        <input type="text" id="searchInput" placeholder="Search name (e.g. Navy)">
                        <button class="search-btn" onclick="searchByName()">Go</button>
                    </div>

                    <div id="pickerMap" class="picker-area">
                        <div class="picker-white"></div>
                        <div class="picker-black"></div>
                        <div id="pickerCursor" class="picker-cursor"></div>
                    </div>

                    <div class="hue-slider-container">
                        <input type="range" id="hueSlider" class="hue-range" min="0" max="360" value="0">
                    </div>
                    
                    <div class="input-row">
                        <label>Hex</label>
                        <input type="text" id="hexInput" value="#005288" maxlength="7">
                    </div>

                    <div class="input-row">
                        <label>RGB</label>
                        <input type="text" id="rgbInput" value="rgb(0, 255, 127)">
                    </div>

                    <div class="input-row">
                        <label>HSL</label>
                        <input type="text" id="hslInput" value="hsl(150, 100%, 50%)">
                    </div>

                    <hr style="border-color:#444; margin: 1.5rem 0;">

                    <div class="palette-header">
                        <span style="color:#aaa; font-size:0.9rem;">Preset Palette:</span>
                        <button class="reset-link" onclick="resetPalette()">Reset Default</button>
                    </div>
                    
                    <div id="paletteContainer" class="palette-grid">
                        </div>
                    <p style="font-size: 0.7rem; color: #555; margin-top: 5px;">* Right-click to delete a color</p>

                </div>

                <div class="panel">
                    <h2>Preview & Data</h2>
                    
                    <div id="mainSwatch"></div>

                    <div class="identity-box">
                        <span style="color:#aaa; font-size:0.8rem; text-transform:uppercase;">Color Name</span>
                        <h3 id="colorNameDisplay">Loading...</h3>
                        <span id="colorExactMatch" class="exact-tag">Approximate</span>
                    </div>

                    <div id="whiteTest" class="contrast-box" style="color: white;">
                        <span>Text on White</span>
                        <div style="display:flex; justify-content:space-between;">
                            <span id="ratioWhite">Ratio: 2.5:1</span>
                            <span id="badgeWhite" class="badge fail">FAIL</span>
                        </div>
                    </div>

                    <div id="blackTest" class="contrast-box" style="color: black;">
                        <span>Text on Black</span>
                        <div style="display:flex; justify-content:space-between;">
                            <span id="ratioBlack">Ratio: 15.2:1</span>
                            <span id="badgeBlack" class="badge pass">PASS</span>
                        </div>
                    </div>
                </div>

            </div>
        </main>
        
        <footer class="site-footer">
            <p><a href="/tools/">< Back to Tools</a></p>
        </footer>
    </div> 

    <script>
        // --- DOM ELEMENTS ---
        const hexInput = document.getElementById('hexInput');
        const rgbInput = document.getElementById('rgbInput');
        const hslInput = document.getElementById('hslInput');
        const swatch = document.getElementById('mainSwatch');
        const searchInput = document.getElementById('searchInput'); 
        
        // Picker Elements
        const pickerMap = document.getElementById('pickerMap');
        const pickerCursor = document.getElementById('pickerCursor');
        const hueSlider = document.getElementById('hueSlider');
        
        // Name Display Elements
        const nameDisplay = document.getElementById('colorNameDisplay');
        const exactTag = document.getElementById('colorExactMatch');

        // Palette Elements
        const paletteContainer = document.getElementById('paletteContainer');

        // --- GLOBAL VARIABLES ---
        let debounceTimer; 
        let isDragging = false;
        
        // Picker State
        let currentHue = 0;
        let currentSat = 100;
        let currentVal = 100;

        // Custom Color Overrides
        const customColorNames = {
            '#00ff7f': 'Madafue Green',
            '#005288': 'Town Centre Blue',
        };

        // --- PALETTE SYSTEM ---
        const DEFAULT_PALETTE = ['#ff0000', '#00ff7f', '#0000ff', '#ffff00', '#ffffff'];
        let myPalette = [];

        // Load on Start
        function loadPalette() {
            const stored = localStorage.getItem('chromaPalette');
            if (stored) {
                myPalette = JSON.parse(stored);
            } else {
                myPalette = [...DEFAULT_PALETTE]; // Copy defaults
            }
            renderPalette();
        }

        function renderPalette() {
            paletteContainer.innerHTML = ''; // Clear current

            myPalette.forEach((color, index) => {
                const btn = document.createElement('button');
                btn.className = 'palette-btn';
                btn.style.backgroundColor = color;
                btn.onclick = () => {
                    hexInput.value = color;
                    updateAll(color);
                };
                
                btn.oncontextmenu = (e) => {
                    e.preventDefault(); // Stop standard menu
                    deleteFromPalette(index);
                };
                
                paletteContainer.appendChild(btn);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'add-btn';
            addBtn.innerText = '+';
            addBtn.title = "Save current color";
            addBtn.onclick = addToPalette;
            paletteContainer.appendChild(addBtn);
        }

        function addToPalette() {
            const currentHex = hexInput.value;
            if (!myPalette.includes(currentHex)) {
                myPalette.push(currentHex);
                savePalette();
                renderPalette();
            }
        }

        function deleteFromPalette(index) {
            if (confirm("Remove this color from preset?")) {
                myPalette.splice(index, 1);
                savePalette();
                renderPalette();
            }
        }

        // Reset Palette
        function resetPalette() {
            if (confirm("Reset palette to defaults?")) {
                myPalette = [...DEFAULT_PALETTE];
                savePalette();
                renderPalette();
            }
        }

        // Save to Storage
        function savePalette() {
            localStorage.setItem('chromaPalette', JSON.stringify(myPalette));
        }

        // --- INITIAL LOAD ---
        loadPalette();
        updateAll(hexInput.value);

        // --- EVENT LISTENERS ---
        hexInput.addEventListener('input', (e) => updateAll(e.target.value));
        
        searchInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchByName();
        });

        hueSlider.addEventListener('input', (e) => {
            currentHue = parseInt(e.target.value);
            pickerMap.style.backgroundColor = `hsl(${currentHue}, 100%, 50%)`;
            updateFromPicker();
        });

        pickerMap.addEventListener('mousedown', (e) => { isDragging = true; handleMapMove(e); });
        window.addEventListener('mousemove', (e) => { if (isDragging) handleMapMove(e); });
        window.addEventListener('mouseup', () => { isDragging = false; });

        // --- SEARCH FUNCTION ---
        async function searchByName() {
            const query = searchInput.value.trim().toLowerCase();
            if(!query) return;

            nameDisplay.innerText = "Searching...";
            exactTag.innerText = "Querying Database...";
            exactTag.className = "exact-tag"; 

            for (const [hex, name] of Object.entries(customColorNames)) {
                if (name.toLowerCase() === query) {
                    updateAll(hex);
                    nameDisplay.innerText = name;
                    exactTag.innerText = "Custom Override";
                    exactTag.className = "exact-tag yes";
                    return;
                }
            }

            const temp = document.createElement('div');
            temp.style.color = 'rgba(0,0,0,0)';
            temp.style.color = query;
            document.body.appendChild(temp);
            const style = window.getComputedStyle(temp).color;
            document.body.removeChild(temp);

            if (style !== 'rgba(0, 0, 0, 0)' && style !== 'transparent') {
                updateAll(style);
                return;
            }

            try {
                const response = await fetch(`https://api.color.pizza/v1/names/?name=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error("API Error");
                
                const data = await response.json();

                if (data.colors && data.colors.length > 0) {
                    let bestMatch = data.colors[0]; 
                    const exactHit = data.colors.find(c => c.name.toLowerCase() === query);
                    if (exactHit) bestMatch = exactHit;

                    updateAll(bestMatch.hex);
                } else {
                    throw new Error("No results");
                }
            } catch (error) {
                nameDisplay.innerText = "Not Found";
                exactTag.innerText = "Try a standard name";
                exactTag.className = "exact-tag fail";
            }
        }

        // --- CORE UPDATE FUNCTION ---
        function updateAll(colorStr) {
            const temp = document.createElement('div');
            temp.style.color = colorStr;
            document.body.appendChild(temp);
            const style = window.getComputedStyle(temp).color;
            document.body.removeChild(temp);

            if (!style || style === '') return;

            const rgbValues = style.match(/\d+/g).map(Number);
            const [r, g, b] = rgbValues;

            if (document.activeElement !== rgbInput) rgbInput.value = `rgb(${r}, ${g}, ${b})`;
            if (document.activeElement !== hexInput) hexInput.value = rgbToHex(r, g, b);
            if (document.activeElement !== hslInput) hslInput.value = rgbToHsl(r, g, b);

            swatch.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
            checkContrast(r, g, b);

            if (!isDragging) {
                updateVisualPicker(r, g, b);
            }

            const currentHex = rgbToHex(r, g, b);
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                fetchColorName(currentHex);
            }, 300);
        }

        // --- IDENTIFICATION ---
        async function fetchColorName(hex) {
            if (customColorNames[hex]) {
                nameDisplay.innerText = customColorNames[hex];
                exactTag.innerText = "Custom Override";
                exactTag.className = "exact-tag yes";
                return;
            }

            try {
                const cleanHex = hex.substring(1);
                const response = await fetch(`https://api.color.pizza/v1/${cleanHex}`);
                if (!response.ok) throw new Error("API Error");
                
                const data = await response.json();

                if (data.colors && data.colors.length > 0) {
                    const match = data.colors[0];
                    nameDisplay.innerText = match.name;
                    if (match.hex.toLowerCase() === hex.toLowerCase()) {
                        exactTag.innerText = "Exact Match";
                        exactTag.className = "exact-tag yes";
                    } else {
                        exactTag.innerText = "Nearest Match";
                        exactTag.className = "exact-tag";
                    }
                }
            } catch (error) {
                console.error(error);
                nameDisplay.innerText = "Unknown";
                exactTag.innerText = "Offline";
            }
        }

        // --- VISUAL PICKER LOGIC ---
        function updateVisualPicker(r, g, b) {
            const hsv = rgbToHsv(r, g, b);
            currentHue = hsv[0];
            currentSat = hsv[1];
            currentVal = hsv[2];

            hueSlider.value = currentHue;
            pickerMap.style.backgroundColor = `hsl(${currentHue}, 100%, 50%)`;

            const rect = pickerMap.getBoundingClientRect();
            const width = rect.width || 100; 
            const height = rect.height || 180;

            const x = (currentSat / 100) * width;
            const y = (1 - (currentVal / 100)) * height;

            pickerCursor.style.left = x + 'px';
            pickerCursor.style.top = y + 'px';
        }

        function handleMapMove(e) {
            const rect = pickerMap.getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;

            x = Math.max(0, Math.min(x, rect.width));
            y = Math.max(0, Math.min(y, rect.height));

            pickerCursor.style.left = x + 'px';
            pickerCursor.style.top = y + 'px';

            currentSat = (x / rect.width) * 100;
            currentVal = 100 - ((y / rect.height) * 100);

            updateFromPicker();
        }

        function updateFromPicker() {
            const rgb = hsvToRgb(currentHue, currentSat, currentVal);
            updateAll(`rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`);
        }

        // --- MATH HELPERS ---
        function rgbToHex(r, g, b) {
            return "#" + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) { h = s = 0; } 
            else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return `hsl(${(h * 360).toFixed(0)}, ${(s * 100).toFixed(0)}%, ${(l * 100).toFixed(0)}%)`;
        }

        function rgbToHsv(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, v = max;
            let d = max - min;
            s = max === 0 ? 0 : d / max;
            if (max === min) { h = 0; } 
            else {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [Math.round(h * 360), Math.round(s * 100), Math.round(v * 100)];
        }

        function hsvToRgb(h, s, v) {
            s /= 100; v /= 100;
            let c = v * s;
            let x = c * (1 - Math.abs(((h / 60) % 2) - 1));
            let m = v - c;
            let r = 0, g = 0, b = 0;
            if (0 <= h && h < 60) { r = c; g = x; b = 0; }
            else if (60 <= h && h < 120) { r = x; g = c; b = 0; }
            else if (120 <= h && h < 180) { r = 0; g = c; b = x; }
            else if (180 <= h && h < 240) { r = 0; g = x; b = c; }
            else if (240 <= h && h < 300) { r = x; g = 0; b = c; }
            else if (300 <= h && h < 360) { r = c; g = 0; b = x; }
            return [Math.round((r + m) * 255), Math.round((g + m) * 255), Math.round((b + m) * 255)];
        }

        function setColor(hex) {
            hexInput.value = hex;
            updateAll(hex);
        }

        function checkContrast(r, g, b) {
            const luminance = (val) => {
                val /= 255;
                return val <= 0.03928 ? val / 12.92 : Math.pow((val + 0.055) / 1.055, 2.4);
            };
            const L1 = (0.2126 * luminance(r)) + (0.7152 * luminance(g)) + (0.0722 * luminance(b));
            const ratioWhite = (1 + 0.05) / (L1 + 0.05);
            const ratioBlack = (L1 + 0.05) / (0 + 0.05);
            updateBadge('White', ratioWhite, document.getElementById('whiteTest'));
            updateBadge('Black', ratioBlack, document.getElementById('blackTest'));
        }

        function updateBadge(type, ratio, container) {
            const el = document.getElementById('ratio' + type);
            const badge = document.getElementById('badge' + type);
            container.style.backgroundColor = swatch.style.backgroundColor;
            el.innerText = `Ratio: ${ratio.toFixed(1)}:1`;
            if (ratio >= 4.5) {
                badge.innerText = "PASS (AA)"; badge.className = "badge pass";
                badge.style.background = ""; badge.style.color = "";
            } else if (ratio >= 3.0) {
                badge.innerText = "Large Text"; badge.className = "badge";
                badge.style.background = "#ffc107"; badge.style.color = "#000";
            } else {
                badge.innerText = "FAIL"; badge.className = "badge fail";
                badge.style.background = ""; badge.style.color = "";
            }
        }
    </script>
</body>
</html>